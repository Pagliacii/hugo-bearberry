{{/* Individual chat message shortcode */}}
{{/* New Usage: {{< llmchat-message role="user|assistant" llm-icon="claude" thinking-label="Thought 3.2s" foldable="true" >}}
     {{< llmchat-thought >}}thought content{{< /llmchat-thought >}}
     answer content
     {{< /llmchat-message >}} */}}

{{ $role := .Get "role" | default "user" }}
{{ $thinking := .Get "thinking" }}
{{ $thinkingLabel := .Get "thinking-label" }}
{{ $llmIcon := .Get "llm-icon" | default "default" }}
{{ $foldable := .Get "foldable" | default false }}
{{ $innerContent := .Inner }}

{{/* Check for thought content from llmchat-thought shortcode or thinking parameter */}}
{{ $thoughtContent := "" }}
{{ $hasNestedThought := false }}
{{ $messageContent := $innerContent }}

{{/* Try to get thought from scratchpad (set by llmchat-thought) */}}
{{ if .Page.Scratch.Get "llmchat_thought" }}
  {{ $thoughtContent = (.Page.Scratch.Get "llmchat_thought") }}
  {{ $hasNestedThought = true }}
  {{/* Clear the scratchpad for next message */}}
  {{ .Page.Scratch.Delete "llmchat_thought" }}
{{ end }}

<div class="chat-message chat-message--{{ $role }}">
  <div class="chat-avatar">
    {{ if eq $role "user" }}
      <svg class="chat-icon" viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" fill="currentColor"/>
      </svg>
    {{ else }}
      {{ partial "llm-icon.html" (dict "icon" $llmIcon) }}
    {{ end }}
  </div>

  <div class="chat-message-content">
    {{/* Thinking section - backward compatibility with $thinking parameter or new nested approach
     Note: only one of $thinking (old param) or $hasNestedThought can be true per message */}}
    {{ if and (or $thinking $hasNestedThought) (eq $role "assistant") }}
    <div class="chat-thinking">
      <details class="chat-thinking__details">
        <summary class="chat-thinking__summary">
          {{ if $thinking }}
            Thinking...
          {{ else }}
            {{ $thinkingLabel | default "Thinking..." }}
          {{ end }}
        </summary>
        <div class="chat-thinking__content">
          {{ if $thinking }}
            {{ $thinking | .Page.RenderString }}
          {{ else }}
            {{ $thoughtContent }}
          {{ end }}
        </div>
      </details>
    </div>
    {{ end }}

    {{/* Foldable answer bubble if requested (only for assistant messages) */}}
    {{ if and $foldable (eq $role "assistant") }}
    <div class="chat-bubble chat-bubble--foldable">
      <div class="chat-content collapsed">{{ $messageContent | .Page.RenderString }}</div>
      <div class="chat-bubble__indicator">
        <span class="dots">>>></span>
      </div>
    </div>
    {{ else }}
    <div class="chat-bubble">
      <div class="chat-content">{{ $messageContent | .Page.RenderString }}</div>
    </div>
    {{ end }}
  </div>
</div>